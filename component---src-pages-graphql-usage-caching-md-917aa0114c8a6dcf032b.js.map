{"version":3,"file":"component---src-pages-graphql-usage-caching-md-917aa0114c8a6dcf032b.js","mappings":"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","sources":["webpack://commerce-webapi/./src/pages/graphql/usage/caching.md"],"sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsxRuntime classic */\n/* @jsx mdx */\nimport DefaultLayout from \"/home/runner/work/commerce-webapi/commerce-webapi/node_modules/@adobe/gatsby-theme-aio/src/components/MDXFilter/index.js\";\nexport const _frontmatter = {};\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n  return <div {...props} />;\n};\nconst InlineAlert = makeShortcode(\"InlineAlert\");\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    <h1 {...{\n      \"id\": \"graphql-caching\"\n    }}>{`GraphQL caching`}</h1>\n    <p>{`Adobe Commerce and Magento Open Source can cache pages rendered from the results of certain GraphQL queries with `}<a parentName=\"p\" {...{\n        \"href\": \"https://developer.adobe.com/commerce/php/development/cache/page/\"\n      }}>{`full-page caching`}</a>{`. Full-page caching improves response time and reduces the load on the server. Without caching, each page might need to run blocks of code and retrieve large amounts of information from the database. Only queries submitted with an HTTP GET operation can be cached. POST queries cannot be cached.`}</p>\n    <p>{`The GraphQL schema is cached in the Configuration cache, which can be refreshed from the Cache Management page (`}<strong parentName=\"p\">{`System`}</strong>{` > `}<strong parentName=\"p\">{`Tools`}</strong>{` > `}<strong parentName=\"p\">{`Cache Management`}</strong>{`).`}</p>\n    <h2 {...{\n      \"id\": \"cached-and-uncached-queries\"\n    }}>{`Cached and uncached queries`}</h2>\n    <p>{`The definitions for some queries include cache tags. Full page caching uses these tags to keep track of cached content. They also allow public content to be invalidated. Private content invalidation is handled on the client side.`}</p>\n    <InlineAlert variant=\"info\" slots=\"text\" mdxType=\"InlineAlert\" />\n    <p>{`GraphQL allows you to make multiple queries in a single call. If you specify any uncached query, the system bypasses the cache for all queries in the call.`}</p>\n    <p>{`The application caches the following queries:`}</p>\n    <ul>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`categories`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`category`}</inlineCode>{` (deprecated)`}</li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`categoryList`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`cmsBlocks`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`cmsPage`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`products`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`route`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`urlResolver`}</inlineCode>{` (deprecated)`}</li>\n    </ul>\n    <p>{`The application explicitly disallows caching the following queries.`}</p>\n    <ul>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`cart`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`country`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`countries`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`currency`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`customAttributeMetadata`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`customer`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`customerDownloadableProducts`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`customerOrders`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`customerPaymentTokens`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`storeConfig`}</inlineCode></li>\n      <li parentName=\"ul\"><inlineCode parentName=\"li\">{`wishlist`}</inlineCode>{` (deprecated)`}</li>\n    </ul>\n    <p><a parentName=\"p\" {...{\n        \"href\": \"../develop/index.md\"\n      }}>{`Define the GraphQL schema for a module`}</a>{` describes the syntax of a valid query.`}</p>\n    <h2 {...{\n      \"id\": \"caching-for-logged-in-customers\"\n    }}>{`Caching for logged-in customers`}</h2>\n    <p>{`In general, guest shoppers see the same products, categories, and prices. Guest queries are easy to cache because content can be cached based on the URL and query alone. However, once the guest logs in as a customer, factors such their customer group or status as a B2B merchant can significantly affect what they see on the storefront.`}</p>\n    <p>{`To enable caching for logged-in customers, Magento Open Source 2.4.4 introduces the `}<inlineCode parentName=\"p\">{`X-Magento-Cache-Id`}</inlineCode>{` response header. This header is returned with every GraphQL GET and POST request. Its value is an SHA hash comprised of several factors that are specific to the customer's context. The following values are concatenated prior to being hashed:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`The store ID`}</li>\n      <li parentName=\"ul\">{`The currency code of the store, such as USD or EUR`}</li>\n      <li parentName=\"ul\">{`A Boolean value indicating whether the customer is logged in (true or false)`}</li>\n      <li parentName=\"ul\">{`The customer's group ID`}</li>\n      <li parentName=\"ul\">{`The customer's tax rate, expressed as a percentage, such as 0.0875`}</li>\n      <li parentName=\"ul\">{`A salt value generated the first time any GraphQL request cache status is `}<inlineCode parentName=\"li\">{`Miss`}</inlineCode></li>\n    </ul>\n    <p>{`The resultant hash is calculated as follows:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-php\"\n      }}>{`SHA256(Store ID + Currency + Is-Logged-In + Customer group + Customer tax rate + Salt value)\n`}</code></pre>\n    <p>{`The application caches the results of all applicable queries. If you specify the resultant hash as the input value for the `}<inlineCode parentName=\"p\">{`X-Magento-Cache-Id`}</inlineCode>{` header of a GraphQL request, then the cached results can be loaded. Although POST requests are not cached, the resultant hashed value provide more opportunities to obtain updated cache IDs.`}</p>\n    <p>{`To define additional factors for computing `}<inlineCode parentName=\"p\">{`X-Magento-Cache-Id`}</inlineCode>{` hash values, add a section similar to the following to the `}<a parentName=\"p\" {...{\n        \"href\": \"https://developer.adobe.com/commerce/php/development/build/dependency-injection-file/\"\n      }}>{`di.xml file`}</a>{` of a custom module. The `}<inlineCode parentName=\"p\">{`argument name`}</inlineCode>{` must be set to `}<inlineCode parentName=\"p\">{`idFactorProviders`}</inlineCode>{`, with the additional attribute names assigned as `}<inlineCode parentName=\"p\">{`item names`}</inlineCode>{`.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-xml\"\n      }}>{`<type name=\"Magento\\\\GraphQlCache\\\\Model\\\\CacheId\\\\CacheIdCalculator\">\n    <arguments>\n        <argument name=\"idFactorProviders\" xsi:type=\"array\">\n            <item name=\"currency\" xsi:type=\"object\">Magento\\\\StoreGraphQl\\\\CacheIdFactorProviders\\\\CurrencyProvider</item>\n            <item name=\"store\" xsi:type=\"object\">Magento\\\\StoreGraphQl\\\\CacheIdFactorProviders\\\\StoreProvider</item>\n        </argument>\n    </arguments>\n</type>\n`}</code></pre>\n    <InlineAlert variant=\"info\" slots=\"text\" mdxType=\"InlineAlert\" />\n    <p>{`Adding factors could generate too many unique cache keys, thereby reducing the number of caching hits and affecting performance.`}</p>\n    <h2 {...{\n      \"id\": \"caching-with-varnish\"\n    }}>{`Caching with Varnish`}</h2>\n    <p>{`For on-premise installations, we recommend setting up Varnish as a reverse proxy to serve the full page cache in a production environment. The template `}<inlineCode parentName=\"p\">{`vcl`}</inlineCode>{` file that ships with each release configures support for GraphQL caching. We recommend that you review the template file each release to determine whether you need to update the `}<inlineCode parentName=\"p\">{`default.vcl`}</inlineCode>{` on your system. To view the contents of the latest template file, you can `}<a parentName=\"p\" {...{\n        \"href\": \"https://docs.magento.com/user-guide/system/cache-full-page.html\"\n      }}>{`download a template file from the Admin`}</a>{` or review the `}<inlineCode parentName=\"p\">{`app/code/Magento/PageCache/etc/varnish6.vcl`}</inlineCode>{` file in the code base.`}</p>\n    <p>{`See `}<a parentName=\"p\" {...{\n        \"href\": \"https://experienceleague.adobe.com/docs/commerce-operations/configuration-guide/cache/varnish/config-varnish.html\"\n      }}>{`Configure and use Varnish`}</a>{` and `}<a parentName=\"p\" {...{\n        \"href\": \"https://experienceleague.adobe.com/docs/commerce-operations/configuration-guide/cache/config-varnish-server.html\"\n      }}>{`Configure Varnish and your web server`}</a>{` for more information.`}</p>\n    <h2 {...{\n      \"id\": \"caching-with-fastly\"\n    }}>{`Caching with Fastly`}</h2>\n    <p>{`To cache guest and customer GraphQL query results on Adobe Commerce on cloud infrastructure, the Cloud project must be running the Fastly CDN module for Adobe Commerce and Magento Open Source version 1.2.160 or later.`}</p>\n    <p>{`To enable GraphQL caching on Fastly:`}</p>\n    <ol>\n      <li parentName=\"ol\">{`Upgrade the Fastly CDN Module for Adobe Commerce and Magento Open Source 2.x to version 1.2.160 or later.`}</li>\n      <li parentName=\"ol\">{`Upload the updated VCL code to the Fastly servers.`}</li>\n    </ol>\n    <p><a parentName=\"p\" {...{\n        \"href\": \"https://devdocs.magento.com/cloud/cdn/configure-fastly.html\"\n      }}>{`Set up Fastly`}</a>{` describes how to perform both of these tasks.`}</p>\n    <p>{`By default, the Fastly module for Adobe Commerce and Magento Open Source provides the following VCL configuration for caching guest queries:`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-text\"\n      }}>{`if (req.request == \"GET\" && req.url.path ~ \"/graphql\" && req.url.qs ~ \"query=\") {\n....\n`}</code></pre>\n    <p>{`Fastly will only cache GET requests that contain a query parameter in the request URL.`}</p>\n    <p>{`For logged-in customer requests, the `}<inlineCode parentName=\"p\">{`Authorization Bearer`}</inlineCode>{` token is always present. If the `}<inlineCode parentName=\"p\">{`X-Magento-Cache-Id`}</inlineCode>{` header is also present, then any cookie headers will be ignored in favor of the value in `}<inlineCode parentName=\"p\">{`X-Magento-Cache-Id`}</inlineCode>{`.`}</p>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-text\"\n      }}>{`if (req.http.graphql && !req.http.X-Magento-Cache-Id && req.http.Authorization ~ \"^Bearer\" ) {\n....\n`}</code></pre>\n    <h3 {...{\n      \"id\": \"example\"\n    }}>{`Example`}</h3>\n    <pre><code parentName=\"pre\" {...{\n        \"className\": \"language-text\"\n      }}>{`http://example.com/graphql?query={ products(filter: {sku: {eq: \"Test\"}}) { items { name } } }&variables={}\n....\n`}</code></pre>\n    <InlineAlert variant=\"info\" slots=\"text\" mdxType=\"InlineAlert\" />\n    <p>{`If you call GraphQL queries in the query body rather than the url (for example, as `}<inlineCode parentName=\"p\">{`--data-raw '{\"query\" .... }'`}</inlineCode>{`), the request is not cached.`}</p>\n    <h2 {...{\n      \"id\": \"x-magento-vary-cache-cookie\"\n    }}>{`X-Magento-Vary cache cookie`}</h2>\n    <p>{`The `}<inlineCode parentName=\"p\">{`X-Magento-Vary`}</inlineCode>{` cache cookie is not supported for GraphQL. The `}<inlineCode parentName=\"p\">{`Store`}</inlineCode>{` and `}<inlineCode parentName=\"p\">{`Content-Currency`}</inlineCode>{`  headers, along with the content language (which is deduced) determine the context.`}</p>\n    <h2 {...{\n      \"id\": \"response-headers\"\n    }}>{`Response headers`}</h2>\n    <p>{`In developer mode, the application returns several headers that could be useful for debugging caching problems. These headers are not specific to GraphQL.`}</p>\n    <table>\n      <thead parentName=\"table\">\n        <tr parentName=\"thead\">\n          <th parentName=\"tr\" {...{\n            \"align\": null\n          }}>{`Header`}</th>\n          <th parentName=\"tr\" {...{\n            \"align\": null\n          }}>{`Description`}</th>\n        </tr>\n      </thead>\n      <tbody parentName=\"table\">\n        <tr parentName=\"tbody\">\n          <td parentName=\"tr\" {...{\n            \"align\": null\n          }}><inlineCode parentName=\"td\">{`X-Magento-Cache-Debug`}</inlineCode></td>\n          <td parentName=\"tr\" {...{\n            \"align\": null\n          }}>{`HIT (the page was loaded from cache) or MISS (the page was not loaded from cache.`}</td>\n        </tr>\n        <tr parentName=\"tbody\">\n          <td parentName=\"tr\" {...{\n            \"align\": null\n          }}><inlineCode parentName=\"td\">{`X-Magento-Tags`}</inlineCode></td>\n          <td parentName=\"tr\" {...{\n            \"align\": null\n          }}>{`A list of cache tags that correspond to the catalog, category, or CMS items returned in the query. The application caches these items.`}</td>\n        </tr>\n      </tbody>\n    </table>\n    <h2 {...{\n      \"id\": \"cache-invalidation\"\n    }}>{`Cache invalidation`}</h2>\n    <p>{`The application invalidates the cache when any of the following events occur:`}</p>\n    <ul>\n      <li parentName=\"ul\">{`A change occurs to a specific entity or entities in aggregate. An increase in a product's price is a direct and obvious change. Applying a new tax class tax to products changes a set of products in aggregate.`}</li>\n      <li parentName=\"ul\">{`The `}<inlineCode parentName=\"li\">{`Preview-Version`}</inlineCode>{` header is specified in a query that supports caching.`}</li>\n      <li parentName=\"ul\">{`The system configuration changes.`}</li>\n      <li parentName=\"ul\">{`An administrator flushes or disables the cache from the Admin or with the `}<inlineCode parentName=\"li\">{`bin/magento cache`}</inlineCode>{` command.`}</li>\n    </ul>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"names":["name","_frontmatter","InlineAlert","props","console","warn","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","mdxType","parentName","variant","slots","isMDXComponent"],"sourceRoot":""}