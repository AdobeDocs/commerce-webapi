"use strict";(self.webpackChunkcommerce_webapi=self.webpackChunkcommerce_webapi||[]).push([[4556],{16507:function(e,a,t){t.r(a),t.d(a,{_frontmatter:function(){return m},default:function(){return h}});var n,r=t(87462),o=t(63366),i=(t(15007),t(64983)),l=t(91515),d=["components"],m={},s=(n="InlineAlert",function(e){return console.warn("Component "+n+" was not imported, exported, or provided by MDXProvider as global scope"),(0,i.mdx)("div",e)}),c={_frontmatter:m},p=l.Z;function h(e){var a=e.components,t=(0,o.Z)(e,d);return(0,i.mdx)(p,(0,r.Z)({},c,t,{components:a,mdxType:"MDXLayout"}),(0,i.mdx)("h1",{id:"graphql-caching"},"GraphQL caching"),(0,i.mdx)("p",null,"Adobe Commerce and Magento Open Source can cache pages rendered from the results of certain GraphQL queries with ",(0,i.mdx)("a",{parentName:"p",href:"https://developer.adobe.com/commerce/php/development/cache/page/"},"full-page caching"),". Full-page caching improves response time and reduces the load on the server. Without caching, each page might need to run blocks of code and retrieve large amounts of information from the database. Only queries submitted with an HTTP GET operation can be cached. POST queries cannot be cached."),(0,i.mdx)("p",null,"The GraphQL schema is cached in the Configuration cache, which can be refreshed from the Cache Management page (",(0,i.mdx)("strong",{parentName:"p"},"System")," > ",(0,i.mdx)("strong",{parentName:"p"},"Tools")," > ",(0,i.mdx)("strong",{parentName:"p"},"Cache Management"),")."),(0,i.mdx)("h2",{id:"cached-and-uncached-queries"},"Cached and uncached queries"),(0,i.mdx)("p",null,"The definitions for some queries include cache tags. Full page caching uses these tags to keep track of cached content. They also allow public content to be invalidated. Private content invalidation is handled on the client side."),(0,i.mdx)(s,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,i.mdx)("p",null,"GraphQL allows you to make multiple queries in a single call. If you specify any uncached query, the system bypasses the cache for all queries in the call."),(0,i.mdx)("p",null,"The application caches the following queries:"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"categories")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"category")," (deprecated)"),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"categoryList")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"cmsBlocks")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"cmsPage")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"products")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"route")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"urlResolver")," (deprecated)")),(0,i.mdx)("p",null,"The application explicitly disallows caching the following queries."),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"cart")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"country")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"countries")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"currency")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"customAttributeMetadata")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"customer")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"customerDownloadableProducts")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"customerOrders")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"customerPaymentTokens")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"storeConfig")),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("inlineCode",{parentName:"li"},"wishlist")," (deprecated)")),(0,i.mdx)("p",null,(0,i.mdx)("a",{parentName:"p",href:"../develop/index.md"},"Define the GraphQL schema for a module")," describes the syntax of a valid query."),(0,i.mdx)("h2",{id:"caching-for-logged-in-customers"},"Caching for logged-in customers"),(0,i.mdx)("p",null,"In general, guest shoppers see the same products, categories, and prices. Guest queries are easy to cache because content can be cached based on the URL and query alone. However, once the guest logs in as a customer, factors such their customer group or status as a B2B merchant can significantly affect what they see on the storefront."),(0,i.mdx)("p",null,"To enable caching for logged-in customers, Magento Open Source 2.4.4 introduces the ",(0,i.mdx)("inlineCode",{parentName:"p"},"X-Magento-Cache-Id")," response header. This header is returned with every GraphQL GET and POST request. Its value is an SHA hash comprised of several factors that are specific to the customer's context. The following values are concatenated prior to being hashed:"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},"The store ID"),(0,i.mdx)("li",{parentName:"ul"},"The currency code of the store, such as USD or EUR"),(0,i.mdx)("li",{parentName:"ul"},"A Boolean value indicating whether the customer is logged in (true or false)"),(0,i.mdx)("li",{parentName:"ul"},"The customer's group ID"),(0,i.mdx)("li",{parentName:"ul"},"The customer's tax rate, expressed as a percentage, such as 0.0875"),(0,i.mdx)("li",{parentName:"ul"},"A salt value generated the first time any GraphQL request cache status is ",(0,i.mdx)("inlineCode",{parentName:"li"},"Miss"))),(0,i.mdx)("p",null,"The resultant hash is calculated as follows:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-php"},"SHA256(Store ID + Currency + Is-Logged-In + Customer group + Customer tax rate + Salt value)\n")),(0,i.mdx)("p",null,"The application caches the results of all applicable queries. If you specify the resultant hash as the input value for the ",(0,i.mdx)("inlineCode",{parentName:"p"},"X-Magento-Cache-Id")," header of a GraphQL request, then the cached results can be loaded. Although POST requests are not cached, the resultant hashed value provide more opportunities to obtain updated cache IDs."),(0,i.mdx)("p",null,"To define additional factors for computing ",(0,i.mdx)("inlineCode",{parentName:"p"},"X-Magento-Cache-Id")," hash values, add a section similar to the following to the ",(0,i.mdx)("a",{parentName:"p",href:"https://developer.adobe.com/commerce/php/development/build/dependency-injection-file/"},"di.xml file")," of a custom module. The ",(0,i.mdx)("inlineCode",{parentName:"p"},"argument name")," must be set to ",(0,i.mdx)("inlineCode",{parentName:"p"},"idFactorProviders"),", with the additional attribute names assigned as ",(0,i.mdx)("inlineCode",{parentName:"p"},"item names"),"."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-xml"},'<type name="Magento\\GraphQlCache\\Model\\CacheId\\CacheIdCalculator">\n    <arguments>\n        <argument name="idFactorProviders" xsi:type="array">\n            <item name="currency" xsi:type="object">Magento\\StoreGraphQl\\CacheIdFactorProviders\\CurrencyProvider</item>\n            <item name="store" xsi:type="object">Magento\\StoreGraphQl\\CacheIdFactorProviders\\StoreProvider</item>\n        </argument>\n    </arguments>\n</type>\n')),(0,i.mdx)(s,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,i.mdx)("p",null,"Adding factors could generate too many unique cache keys, thereby reducing the number of caching hits and affecting performance."),(0,i.mdx)("h2",{id:"caching-with-varnish"},"Caching with Varnish"),(0,i.mdx)("p",null,"For on-premise installations, we recommend setting up Varnish as a reverse proxy to serve the full page cache in a production environment. The template ",(0,i.mdx)("inlineCode",{parentName:"p"},"vcl")," file that ships with each release configures support for GraphQL caching. We recommend that you review the template file each release to determine whether you need to update the ",(0,i.mdx)("inlineCode",{parentName:"p"},"default.vcl")," on your system. To view the contents of the latest template file, you can ",(0,i.mdx)("a",{parentName:"p",href:"https://docs.magento.com/user-guide/system/cache-full-page.html"},"download a template file from the Admin")," or review the ",(0,i.mdx)("inlineCode",{parentName:"p"},"app/code/Magento/PageCache/etc/varnish6.vcl")," file in the code base."),(0,i.mdx)("p",null,"See ",(0,i.mdx)("a",{parentName:"p",href:"https://experienceleague.adobe.com/docs/commerce-operations/configuration-guide/cache/varnish/config-varnish.html"},"Configure and use Varnish")," and ",(0,i.mdx)("a",{parentName:"p",href:"https://experienceleague.adobe.com/docs/commerce-operations/configuration-guide/cache/config-varnish-server.html"},"Configure Varnish and your web server")," for more information."),(0,i.mdx)("h2",{id:"caching-with-fastly"},"Caching with Fastly"),(0,i.mdx)("p",null,"To cache guest and customer GraphQL query results on Adobe Commerce on cloud infrastructure, the Cloud project must be running the Fastly CDN module for Adobe Commerce and Magento Open Source version 1.2.160 or later."),(0,i.mdx)("p",null,"To enable GraphQL caching on Fastly:"),(0,i.mdx)("ol",null,(0,i.mdx)("li",{parentName:"ol"},"Upgrade the Fastly CDN Module for Adobe Commerce and Magento Open Source 2.x to version 1.2.160 or later."),(0,i.mdx)("li",{parentName:"ol"},"Upload the updated VCL code to the Fastly servers.")),(0,i.mdx)("p",null,(0,i.mdx)("a",{parentName:"p",href:"https://devdocs.magento.com/cloud/cdn/configure-fastly.html"},"Set up Fastly")," describes how to perform both of these tasks."),(0,i.mdx)("p",null,"By default, the Fastly module for Adobe Commerce and Magento Open Source provides the following VCL configuration for caching guest queries:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-text"},'if (req.request == "GET" && req.url.path ~ "/graphql" && req.url.qs ~ "query=") {\n....\n')),(0,i.mdx)("p",null,"Fastly will only cache GET requests that contain a query parameter in the request URL."),(0,i.mdx)("p",null,"For logged-in customer requests, the ",(0,i.mdx)("inlineCode",{parentName:"p"},"Authorization Bearer")," token is always present. If the ",(0,i.mdx)("inlineCode",{parentName:"p"},"X-Magento-Cache-Id")," header is also present, then any cookie headers will be ignored in favor of the value in ",(0,i.mdx)("inlineCode",{parentName:"p"},"X-Magento-Cache-Id"),"."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-text"},'if (req.http.graphql && !req.http.X-Magento-Cache-Id && req.http.Authorization ~ "^Bearer" ) {\n....\n')),(0,i.mdx)("h3",{id:"example"},"Example"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-text"},'http://example.com/graphql?query={ products(filter: {sku: {eq: "Test"}}) { items { name } } }&variables={}\n....\n')),(0,i.mdx)(s,{variant:"info",slots:"text",mdxType:"InlineAlert"}),(0,i.mdx)("p",null,"If you call GraphQL queries in the query body rather than the url (for example, as ",(0,i.mdx)("inlineCode",{parentName:"p"},"--data-raw '{\"query\" .... }'"),"), the request is not cached."),(0,i.mdx)("h2",{id:"x-magento-vary-cache-cookie"},"X-Magento-Vary cache cookie"),(0,i.mdx)("p",null,"The ",(0,i.mdx)("inlineCode",{parentName:"p"},"X-Magento-Vary")," cache cookie is not supported for GraphQL. The ",(0,i.mdx)("inlineCode",{parentName:"p"},"Store")," and ",(0,i.mdx)("inlineCode",{parentName:"p"},"Content-Currency"),"  headers, along with the content language (which is deduced) determine the context."),(0,i.mdx)("h2",{id:"response-headers"},"Response headers"),(0,i.mdx)("p",null,"In developer mode, the application returns several headers that could be useful for debugging caching problems. These headers are not specific to GraphQL."),(0,i.mdx)("table",null,(0,i.mdx)("thead",{parentName:"table"},(0,i.mdx)("tr",{parentName:"thead"},(0,i.mdx)("th",{parentName:"tr",align:null},"Header"),(0,i.mdx)("th",{parentName:"tr",align:null},"Description"))),(0,i.mdx)("tbody",{parentName:"table"},(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"X-Magento-Cache-Debug")),(0,i.mdx)("td",{parentName:"tr",align:null},"HIT (the page was loaded from cache) or MISS (the page was not loaded from cache.")),(0,i.mdx)("tr",{parentName:"tbody"},(0,i.mdx)("td",{parentName:"tr",align:null},(0,i.mdx)("inlineCode",{parentName:"td"},"X-Magento-Tags")),(0,i.mdx)("td",{parentName:"tr",align:null},"A list of cache tags that correspond to the catalog, category, or CMS items returned in the query. The application caches these items.")))),(0,i.mdx)("h2",{id:"cache-invalidation"},"Cache invalidation"),(0,i.mdx)("p",null,"The application invalidates the cache when any of the following events occur:"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},"A change occurs to a specific entity or entities in aggregate. An increase in a product's price is a direct and obvious change. Applying a new tax class tax to products changes a set of products in aggregate."),(0,i.mdx)("li",{parentName:"ul"},"The ",(0,i.mdx)("inlineCode",{parentName:"li"},"Preview-Version")," header is specified in a query that supports caching."),(0,i.mdx)("li",{parentName:"ul"},"The system configuration changes."),(0,i.mdx)("li",{parentName:"ul"},"An administrator flushes or disables the cache from the Admin or with the ",(0,i.mdx)("inlineCode",{parentName:"li"},"bin/magento cache")," command.")))}h.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-graphql-usage-caching-md-917aa0114c8a6dcf032b.js.map